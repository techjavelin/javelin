version: 1
backend:
  phases:
    build:
      commands:
        # Ensure Node 20 (some dependencies require >=20; build image may default to 18)
        - |
          if command -v nvm >/dev/null 2>&1; then
            nvm install 20 >/dev/null 2>&1 || nvm use 20 || true;
            node -v; npm -v;
          else
            echo "nvm not available; relying on build image Node version";
            node -v; npm -v;
          fi
        # Install dependencies (clean, reproducible)
        - npm ci --cache .npm --prefer-offline
        # Early enum registration validation (fast fail)
        - npm run validate:enums
        # Type-check tests & source (tests use separate tsconfig for vitest types)
        # - npm run test:typecheck
        # Run unit tests in CI mode (will fail pipeline on non-zero exit)
        - CI=1 npm run test:ci
        # Deploy backend (Amplify Gen 2) only if all previous steps succeed
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
