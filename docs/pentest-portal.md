# Pentest Portal Architecture

## Overview
The Pentest Portal provides an authenticated workspace for managing security testing engagements, findings, artifacts, and participant roles. It layers capability-based authorization on top of Amplify Data models to ensure fine-grained access control at the engagement scope.

## Domain Models (Amplify Schema)
- Engagement: Core unit of a security test (fields: id, code, title, organizationId, phase, status, createdAt, updatedAt, ...)
- VulnerabilityFinding: Individual vulnerability record linked to an engagement (severity, status, remediation metadata)
- ArtifactLink: External or generated document (e.g. report draft, evidence bundle) associated with an engagement
- VulnerabilityTemplate: Reusable finding template for faster reporting
- ApplicationEngagement: Join table linking applications under test to an engagement
- EngagementRoleAssignment: (Planned) Associates a principal with a scoped role for the engagement

## Authorization Model
Authorization is capability-driven using `useAuthorization()` composable.

### Capability Namespaces
- ORG.*   Organization-wide administrative actions
- APP.*   Application-level actions
- ENG.*   Engagement-scoped actions

### Key Capabilities in Portal
- ENG.MANAGE: Update engagement state (phase/status), create artifacts, create engagements
- ENG.UPDATE_FINDING: Create or update vulnerability findings

The `has(capability, context)` call evaluates hierarchical inheritance and cached role → capability mappings. Context objects include identifiers: `{ engagementId }`, `{ organizationId }`, or combined.

## Composables
### useEngagements
Provides list/get/updateState plus backward-compatible `engagements` ref and a minimal `create` method with ENG.MANAGE gating. Adds alias to ease migration from legacy pentester pages.

### useVulnerabilityFindings
CRUD for findings with client-side filtering; will evolve to server-side filters. Uses ENG.UPDATE_FINDING gating externally in UI (capability checks performed before showing create buttons; can be inlined inside composable later).

### useArtifacts
Manages artifact links with ENG.MANAGE gating on create/update. Exposes `listByEngagement` and a generic `list` alias for dashboard use.

### useUserProfile
Supports secure self-update/delete via custom Lambda-backed mutations (`updateUserProfileSecure`, `deleteUserProfileSecure`). Fetch corrected to primary key `{ id }`.

### useEngagementParticipants
Lists and manages scoped participant role assignments (`EngagementRoleAssignment`). Enforces `ENG.MANAGE` for assign/remove. Uses composite identifier (engagementId + userId) and requires `applicationId` for creation (denormalized join).

### usePagination
Lightweight helper supplying `nextToken`, `itemsPerPage`, and reset/update methods; used by `useEngagements` (and can extend to findings/artifacts later) for forward-only pagination.

## Pages
- EngagementsList.vue: Lists engagements and conditionally shows a create button when `ENG.MANAGE` is present.
- EngagementDetail.vue: Tabbed skeleton (Overview, Findings, Artifacts, Participants) with capability-gated actions.
- NewEngagement.vue & NewFinding.vue: Legacy creation forms retained; now functional again via backward-compatible composable aliases.
- PentesterDashboard.vue: Aggregated metrics (engagement phases, artifact recency, findings severity summary).
 - Participants tab: Shows current assignments, allows adding/removing participants (when `ENG.MANAGE`).

## Testing Strategy
Integration test `tests/integration/pentestPortal.integration.test.ts` validates capability gating logic across engagements, findings, and artifacts operations with mocked authorization states.

Unit tests:
- Authorization (basic + advanced) for capability resolution & caching.
- `capGate.test.ts` validates conditional slot rendering including inverse logic.
- `participants.test.ts` covers assignment gating (deny vs allow) and composite key remove.

## Pending / Future Enhancements
- Bidirectional pagination / infinite scroll (currently forward-only via nextToken)
- Artifact upload workflows (evidence bundles, file storage integration)
- Bulk assignment & role editing UI for participants
- Sorting & multi-filter facets in engagements/findings lists
- Debounced search input driving server-side filters

## Migration Notes
Legacy code expecting `useEngagements().engagements` and `.create()` now works via aliases. New code should prefer `items` and explicit `list()`; legacy APIs will be deprecated after participants & advanced filtering ship.

## Security Considerations
- All mutating operations verify capability prior to action (defense-in-depth with UI gating + composable runtime checks)
- Future: add optimistic concurrency tokens to engagement and finding updates if required
- Custom secure profile mutations rely on SigV4-signed Lambda resolvers (see functions/profile)

## Developer Workflow
1. Add/modify schema in Amplify → regenerate types.
2. Implement or update composable leveraging generated types (`Schema[...]`).
3. Add capability checks early in composable or UI before invoking mutations.
4. Extend integration tests to cover new capability flows.
5. Ensure `npm run type-check` & `npx vitest run` pass in CI.

## Quick Reference
| Action | Capability | Composable | Method |
|--------|------------|------------|--------|
| List engagements | (implicit) | useEngagements | list() |
| Create engagement | ENG.MANAGE | useEngagements | create() |
| Update phase/status | ENG.MANAGE | useEngagements | updateState() |
| List findings | (implicit) | useVulnerabilityFindings | list() |
| Create/update finding | ENG.UPDATE_FINDING | useVulnerabilityFindings | create()/update() |
| List artifacts | (implicit) | useArtifacts | list()/listByEngagement() |
| Create/update artifact | ENG.MANAGE | useArtifacts | create()/update() |
| List participants | (implicit) | useEngagementParticipants | list() |
| Assign/remove participant | ENG.MANAGE | useEngagementParticipants | assign()/remove() |

---
This document should be updated as participants management, server-side filtering, and artifact workflows evolve.
