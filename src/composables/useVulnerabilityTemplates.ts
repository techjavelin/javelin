import { ref } from 'vue'
import { generateClient } from 'aws-amplify/data'
import type { Schema } from '../../amplify/data/resource'
import { withAuth } from '../amplifyClient'
import { normalizeError } from './useError'

const client = generateClient<Schema>()

export function useVulnerabilityTemplates() {
  const templates = ref<Schema['VulnerabilityTemplate']['type'][]>([])
  const loading = ref(false)
  const error = ref<string>('')

  async function list() {
    loading.value = true
    error.value = ''
    try {
      const res = await client.models.VulnerabilityTemplate.list(withAuth({}))
      templates.value = res.data || []
    } catch (e:any) {
      error.value = normalizeError(e,'Failed to load templates').message
    } finally {
      loading.value = false
    }
  }

  async function create(input: Partial<Schema['VulnerabilityTemplate']['type']>) {
    try {
      const res = await client.models.VulnerabilityTemplate.create(withAuth({
        title: input.title!,
        category: (input.category as any) || 'OTHER',
        severity: (input.severity as any) || 'MEDIUM',
        description: input.description || '',
        remediation: input.remediation || '',
        impact: input.impact || '',
        likelihood: input.likelihood || '',
        references: input.references || [],
        tags: input.tags || [],
        cvssVector: input.cvssVector || '',
        owaspCategory: input.owaspCategory || '',
        isGlobal: input.isGlobal ?? false
      }))
      if (res.data) templates.value.push(res.data)
      return res.data
    } catch (e:any) {
      error.value = normalizeError(e,'Failed to create template').message
      return null
    }
  }

  async function update(id: string, patch: Partial<Schema['VulnerabilityTemplate']['type']>) {
    try {
      const res = await client.models.VulnerabilityTemplate.update(withAuth({ id, ...patch }))
      if (res.data) {
        const idx = templates.value.findIndex(t => t.id === id)
        if (idx >= 0) templates.value[idx] = res.data
      }
      return res.data
    } catch (e:any) {
      error.value = normalizeError(e,'Failed to update template').message
      return null
    }
  }

  async function remove(id: string) {
    try {
      await client.models.VulnerabilityTemplate.delete(withAuth({ id }))
      templates.value = templates.value.filter(t => t.id !== id)
    } catch (e:any) {
      error.value = normalizeError(e,'Failed to delete template').message
    }
  }

  return { templates, loading, error, list, create, update, remove }
}
