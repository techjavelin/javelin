<template>
  <DashboardLayout>
    <template #header>
      <h1 class="dashboard-title">Applications</h1>
    </template>
    <div class="pentester-applications">

    <div class="org-selector" v-if="organizations.length > 1">
      <label>Select Organization</label>
      <select v-model="selectedOrgId" @change="onOrgChange">
        <option v-for="o in organizations" :key="o.id" :value="o.id">{{ o.name }}</option>
      </select>
    </div>

    <div class="actions" v-if="currentOrgId && canManage">
      <button class="btn primary" @click="openCreate()">New Application</button>
    </div>

    <div v-if="appsLoading" class="loading">Loading applications...</div>
    <div v-else-if="appsError" class="error">{{ appsError }}</div>

    <table v-if="!appsLoading && applications.length" class="apps-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>User Types</th>
          <th>Sensitivity</th>
          <th>Description</th>
          <th v-if="canManage">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="app in applications" :key="app.id">
          <td>{{ app.name }}</td>
          <td>{{ app.applicationTypeKey }}</td>
          <td>
            <span v-if="app.userTypeKeys && app.userTypeKeys.length" class="comma-list">{{ app.userTypeKeys.filter(Boolean).join(', ') }}</span>
            <span v-else>-</span>
          </td>
          <td>{{ app.dataSensitivity || '-' }}</td>
          <td>{{ app.description || '-' }}</td>
          <td v-if="canManage">
            <button class="btn small" @click="startEdit(app)">Edit</button>
            <button class="btn small danger" @click="confirmDelete(app)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div v-else-if="!appsLoading" class="empty">No applications found.</div>

    <!-- Create / Edit Modal -->
    <div v-if="showModal" class="modal-backdrop">
      <div class="modal">
        <h2>{{ editTarget ? 'Edit Application' : 'New Application' }}</h2>
        <form @submit.prevent="submit">
          <div class="field">
            <label>Name</label>
            <input v-model="form.name" required :disabled="saving" />
          </div>
          <div class="field">
            <label>Application Type</label>
            <select v-model="form.applicationTypeKey" required :disabled="saving || !!editTarget">
              <option value="">-- Select Type --</option>
              <option v-for="t in applicationTypes" :key="t.id" :value="t.key">{{ t.label }}</option>
            </select>
          </div>
          <div class="field">
            <label>User Types (Audiences)</label>
            <div class="multi-select-box">
              <div class="pill" v-for="u in userTypes" :key="u.id" @click="toggleUserType(u.key)" :class="{ selected: form.userTypeKeys.includes(u.key) }">
                {{ u.label }}
              </div>
            </div>
          </div>
          <div class="field">
            <label>Data Sensitivity</label>
            <input v-model="form.dataSensitivity" placeholder="e.g., Internal, Confidential" :disabled="saving" />
          </div>
          <div class="field">
            <label>Description</label>
            <textarea v-model="form.description" rows="3" :disabled="saving" />
          </div>
          <div class="field">
            <label>Repo URL</label>
            <input v-model="form.repoUrl" :disabled="saving" />
          </div>
          <div class="field">
            <label>Prod URL</label>
            <input v-model="form.prodUrl" :disabled="saving" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn" @click="closeModal" :disabled="saving">Cancel</button>
            <button type="submit" class="btn primary" :disabled="saving || !form.name">{{ saving ? 'Saving...' : 'Save' }}</button>
          </div>
          <div class="error" v-if="saveError">{{ saveError }}</div>
        </form>
      </div>
    </div>

    <!-- Delete Confirm -->
    <div v-if="deleteTarget" class="modal-backdrop">
      <div class="modal">
        <h2>Delete Application</h2>
        <p>Are you sure you want to delete <strong>{{ deleteTarget.name }}</strong>? This cannot be undone.</p>
        <div class="modal-actions">
          <button class="btn" @click="deleteTarget = null">Cancel</button>
          <button class="btn danger" @click="performDelete" :disabled="saving">{{ saving ? 'Deleting...' : 'Delete' }}</button>
        </div>
        <div class="error" v-if="saveError">{{ saveError }}</div>
      </div>
    </div>
    </div>
  </DashboardLayout>
</template>

<script setup lang="ts">
import { computed, onMounted, reactive, ref, watch } from 'vue'
import { useOrganizations } from '../composables/useOrganizations'
import { useApplications } from '../composables/useApplications'
import { useApplicationTypes } from '../composables/useApplicationTypes'
import { useUserTypes } from '../composables/useUserTypes'
import type { Schema } from '../../amplify/data/resource'
import DashboardLayout from '../layouts/DashboardLayout.vue'
import { useToasts } from '../composables/useToasts'

const { organizations, fetchOrganizations } = useOrganizations()
const { applications, list, create, update, remove, canManageOrg, loading: appsLoading, error: appsError } = useApplications()
const { types: applicationTypes, list: listApplicationTypes } = useApplicationTypes()
const { types: userTypes, list: listUserTypes } = useUserTypes()

const selectedOrgId = ref<string>('')
const currentOrgId = computed(()=> selectedOrgId.value || (organizations.value[0]?.id || ''))
const canManage = computed(()=> currentOrgId.value ? canManageOrg(currentOrgId.value) : false)

// Modal state
const showModal = ref(false)
const saving = ref(false)
const saveError = ref('')
const editTarget = ref<Schema['Application']['type'] | null>(null)
const deleteTarget = ref<Schema['Application']['type'] | null>(null)

// Legacy mapping removed; using data-driven models now.

const { add: addToast } = useToasts()

const form = reactive<{ name: string; applicationTypeKey: string; userTypeKeys: string[]; description?: string; repoUrl?: string; prodUrl?: string; dataSensitivity?: string }>({
  name: '',
  applicationTypeKey: '',
  userTypeKeys: [],
  description: '',
  repoUrl: '',
  prodUrl: '',
  dataSensitivity: ''
})

function resetForm(app?: Schema['Application']['type']) {
  if(app){
    form.name = app.name
    form.applicationTypeKey = app.applicationTypeKey
  form.userTypeKeys = (app.userTypeKeys || []).filter((v): v is string => !!v)
    form.description = app.description || ''
    form.repoUrl = app.repoUrl || ''
    form.prodUrl = app.prodUrl || ''
    form.dataSensitivity = app.dataSensitivity || ''
  } else {
    form.name = ''
    form.applicationTypeKey = ''
    form.userTypeKeys = []
    form.description = ''
    form.repoUrl = ''
    form.prodUrl = ''
    form.dataSensitivity = ''
  }
}

function onOrgChange(){
  if(currentOrgId.value) refresh()
}

async function refresh(){
  if(!currentOrgId.value) return
  await list({ organizationId: currentOrgId.value, limit: 100 })
}

function openCreate(){
  editTarget.value = null
  resetForm()
  showModal.value = true
}

function startEdit(app: Schema['Application']['type']){
  editTarget.value = app
  resetForm(app)
  showModal.value = true
}

function toggleUserType(key: string){
  const idx = form.userTypeKeys.indexOf(key)
  if(idx>=0) form.userTypeKeys.splice(idx,1)
  else form.userTypeKeys.push(key)
}

function closeModal(){
  showModal.value = false
}

async function submit(){
  if(!currentOrgId.value) return
  saving.value = true
  saveError.value = ''
  try {
    if(!form.applicationTypeKey){
      throw new Error('Select an application type')
    }
    if(editTarget.value){
      await update(editTarget.value.id, {
        description: form.description || undefined,
        repoUrl: form.repoUrl || undefined,
        prodUrl: form.prodUrl || undefined,
        dataSensitivity: form.dataSensitivity || undefined,
        applicationTypeKey: form.applicationTypeKey,
        userTypeKeys: form.userTypeKeys
      })
    } else {
      await create({
        organizationId: currentOrgId.value,
        name: form.name,
        applicationTypeKey: form.applicationTypeKey,
        userTypeKeys: form.userTypeKeys,
        description: form.description || undefined,
        repoUrl: form.repoUrl || undefined,
        prodUrl: form.prodUrl || undefined,
        dataSensitivity: form.dataSensitivity || undefined
      })
    }
    showModal.value = false
    await refresh()
    addToast({ title: editTarget.value ? 'Application Updated' : 'Application Created', message: `${form.name} saved successfully`, type: 'success' })
  } catch (e: any){
    saveError.value = e.message || 'Save failed'
    addToast({ title: 'Save Failed', message: saveError.value, type: 'error', duration: 6500 })
  } finally { saving.value = false }
}

function confirmDelete(app: Schema['Application']['type']){
  deleteTarget.value = app
}

async function performDelete(){
  if(!deleteTarget.value) return
  saving.value = true
  saveError.value = ''
  try {
    await remove(deleteTarget.value.id)
    deleteTarget.value = null
    await refresh()
  } catch (e: any){
    saveError.value = e.message || 'Delete failed'
  } finally { saving.value = false }
}

onMounted(async () => {
  await fetchOrganizations()
  if(!selectedOrgId.value && organizations.value.length){
    selectedOrgId.value = organizations.value[0].id
  }
  await Promise.all([listApplicationTypes(), listUserTypes()])
  await refresh()
})

watch(()=>organizations.value.length, (n)=>{
  if(n && !selectedOrgId.value) selectedOrgId.value = organizations.value[0].id
})
</script>

<style scoped>
.pentester-applications { padding: 1rem; }
.org-selector { margin-bottom: 1rem; }
.actions { margin: 1rem 0; }
.loading { padding: 1rem; }
.error { color: var(--modal-danger-color); margin-top: .5rem; }
.empty { padding: 1rem; font-style: italic; }
.apps-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size:.85rem; }
.apps-table th, .apps-table td { border: 1px solid var(--modal-border-color); padding: .5rem .55rem; text-align: left; }
.apps-table th { background: var(--modal-field-bg); color: var(--modal-muted-color); font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; }
.btn { cursor: pointer; border: 1px solid var(--modal-accent-bg); background: var(--modal-accent-bg); color:#fff; padding: .4rem .75rem; border-radius: 6px; font-size: .7rem; font-weight:600; }
.btn.primary { background: var(--modal-accent-bg); }
.btn.primary:hover { background: var(--modal-accent-bg-hover); }
.btn.danger { background: var(--modal-danger-color); border-color: var(--modal-danger-color); }
.btn.danger:hover { filter:brightness(1.05); }
.btn.small { font-size: .65rem; padding: .3rem .55rem; }
.field { display:flex; flex-direction:column; margin-bottom:.6rem; }
.field label { font-size: .65rem; text-transform: uppercase; letter-spacing: .05em; margin-bottom: .25rem; color: var(--modal-muted-color); }
.field input, .field select, .field textarea { font-size: .75rem; padding: .45rem .55rem; border:1px solid var(--modal-field-border); background: var(--modal-field-bg); color: var(--modal-text-color); border-radius:6px; }
</style>
