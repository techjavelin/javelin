<template>
  <DashboardLayout>
    <template #header>
      <h1 class="dashboard-title">Pentester Dashboard</h1>
    </template>
    <section class="grid">
      <div class="panel stats">
        <h2>Engagement Overview</h2>
        <div class="stat-grid">
          <div class="stat" v-for="s in engagementStats" :key="s.label">
            <div class="stat-value">{{ s.value }}</div>
            <div class="stat-label">{{ s.label }}</div>
          </div>
        </div>
      </div>
      <div class="panel recent">
        <h2>Recent Artifacts</h2>
        <div v-if="artifactsLoading" class="loading">Loading artifacts...</div>
        <ul v-else-if="recentArtifacts.length" class="artifact-list">
          <li v-for="a in recentArtifacts" :key="a.id">
            <span class="art-name">{{ a.name }}</span>
            <span class="art-meta">{{ (a.size ? (a.size/1024).toFixed(1)+' KB' : 'â€”') }}</span>
          </li>
        </ul>
        <p v-else class="empty">No artifacts yet.</p>
      </div>
      <div class="panel quick">
        <h2>Quick Actions</h2>
        <div class="actions">
          <router-link to="/pentester/engagements/new" class="qa-btn">New Engagement</router-link>
          <router-link to="/pentester/findings/new" class="qa-btn alt">New Finding</router-link>
          <router-link to="/pentester/vuln-library" class="qa-btn alt">Vuln Library</router-link>
        </div>
      </div>
      <div class="panel findings" v-if="findingSummary.total > 0">
        <h2>Findings Summary</h2>
        <div class="findings-grid">
          <div class="f-stat" v-for="f in findingStats" :key="f.label" :data-sev="f.label">
            <div class="f-val">{{ f.value }}</div>
            <div class="f-label">{{ f.label }}</div>
          </div>
        </div>
        <router-link to="/pentester/findings/new" class="qa-btn small mt">Report New</router-link>
      </div>
    </section>
  </DashboardLayout>
</template>
 <script setup lang="ts">
import DashboardLayout from '../layouts/DashboardLayout.vue'
import { onMounted, computed } from 'vue'
import { useEngagements } from '../composables/useEngagements'
import { useArtifacts } from '../composables/useArtifacts'
import { useCurrentOrg } from '../composables/useCurrentOrg'
import { useVulnerabilityFindings } from '../composables/useVulnerabilityFindings'

const { engagements, list: listEngagements } = useEngagements()
const { artifacts, list: listArtifacts, loading: artifactsLoading } = useArtifacts()
const { currentOrgId } = useCurrentOrg()
const { findings, list: listFindings } = useVulnerabilityFindings()

onMounted(async () => {
  await Promise.all([
    listEngagements(),
  currentOrgId.value ? listArtifacts({ organizationId: currentOrgId.value }) : Promise.resolve(),
    listFindings({})
  ])
})

const engagementStats = computed(() => {
  const list = engagements.value || []
  const total = list.length
  const active = list.filter(e => (e as any).status === 'ACTIVE').length
  const planning = list.filter(e => (e as any).phase === 'PLANNING').length
  const reporting = list.filter(e => (e as any).phase === 'REPORTING').length
  return [
    { label: 'Total', value: total },
    { label: 'Active', value: active },
    { label: 'Planning', value: planning },
    { label: 'Reporting', value: reporting }
  ]
})

const recentArtifacts = computed(() => {
  return [...artifacts.value]
    .sort((a,b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''))
    .slice(0,5)
})

interface FindingAggregate { total: number; CRITICAL: number; HIGH: number; MEDIUM: number; LOW: number; INFO: number }
const findingSummary = computed<FindingAggregate>(() => {
  const agg: FindingAggregate = { total: findings.value.length, CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0, INFO:0 }
  for (const f of findings.value) {
    const sev = (f as any).severity as keyof Omit<FindingAggregate,'total'>
    if (sev in agg) (agg as any)[sev]++
  }
  return agg
})

const findingStats = computed(() => [
  { label:'CRITICAL', value: findingSummary.value.CRITICAL },
  { label:'HIGH', value: findingSummary.value.HIGH },
  { label:'MEDIUM', value: findingSummary.value.MEDIUM },
  { label:'LOW', value: findingSummary.value.LOW },
  { label:'INFO', value: findingSummary.value.INFO },
])
</script>
<style scoped>
.dashboard-title { font-size:2rem; font-weight:700; color:#fff; margin-bottom:1rem; }
.grid { display:grid; gap:1.25rem; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); }
.panel { background:#181e2a; padding:1.25rem 1.5rem; border-radius:14px; border:1px solid #243048; position:relative; overflow:hidden; }
.panel h2 { margin:0 0 .75rem; font-size:1.05rem; letter-spacing:.5px; font-weight:600; color:#e2e8f0; }
.stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:.75rem; }
.stat { background:#1f2737; padding:.9rem .75rem; border-radius:10px; text-align:left; border:1px solid #273248; }
.stat-value { font-size:1.4rem; font-weight:600; color:#60a5fa; line-height:1.1; }
.stat-label { font-size:.70rem; text-transform:uppercase; letter-spacing:.08em; color:#94a3b8; margin-top:.25rem; }
.artifact-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.6rem; }
.artifact-list li { display:flex; flex-direction:column; background:#1f2737; padding:.6rem .75rem; border-radius:8px; border:1px solid #273248; }
.art-name { font-weight:500; color:#f1f5f9; font-size:.9rem; }
.art-meta { font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; color:#94a3b8; margin-top:2px; }
.empty { color:#64748b; font-size:.8rem; margin:0; }
.loading { color:#94a3b8; font-size:.8rem; }
.actions { display:flex; flex-wrap:wrap; gap:.6rem; }
.qa-btn { background:#2563eb; color:#fff; padding:.65rem .85rem; border-radius:8px; text-decoration:none; font-size:.75rem; font-weight:500; letter-spacing:.04em; }
.qa-btn.alt { background:#334155; }
.qa-btn:hover { background:#1d4ed8; }
.qa-btn.alt:hover { background:#475569; }
/* Findings tile */
.findings-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(90px,1fr)); gap:.65rem; margin-top:.5rem; }
.f-stat { background:#1f2737; padding:.55rem .5rem; border-radius:8px; text-align:center; border:1px solid #273248; position:relative; }
.f-val { font-size:1.05rem; font-weight:600; line-height:1; margin-bottom:.25rem; }
.f-label { font-size:.55rem; letter-spacing:.08em; font-weight:600; }
.f-stat[data-sev='CRITICAL'] { background:#4c0519; border-color:#7f1d1d; color:#fecaca; }
.f-stat[data-sev='HIGH'] { background:#7f1d1d; border-color:#b91c1c; color:#fee2e2; }
.f-stat[data-sev='MEDIUM'] { background:#78350f; border-color:#a16207; color:#fde68a; }
.f-stat[data-sev='LOW'] { background:#3730a3; border-color:#4338ca; color:#e0e7ff; }
.f-stat[data-sev='INFO'] { background:#1e3a8a; border-color:#1d4ed8; color:#bfdbfe; }
.qa-btn.small { font-size:.65rem; padding:.45rem .65rem; margin-top:.75rem; }
.mt { margin-top:.75rem; display:inline-block; }
@media (max-width:700px){ .grid { grid-template-columns:1fr; } }
</style>
