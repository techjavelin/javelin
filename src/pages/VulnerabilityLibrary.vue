<template>
  <DashboardLayout>
    <h1 class="dashboard-title">Vulnerability Library</h1>
    <section class="library-panel">
      <div class="filters">
        <input v-model="search" placeholder="Search title or description" />
        <select v-model="severityFilter">
          <option value="">All Severities</option>
          <option v-for="s in severities" :key="s" :value="s">{{ s }}</option>
        </select>
        <select v-model="categoryFilter">
          <option value="">All Categories</option>
          <option v-for="c in categories" :key="c" :value="c">{{ c }}</option>
        </select>
        <button class="btn btn-small" @click="openModal">New Template</button>
      </div>
      <div v-if="loading" class="loading">Loading templates...</div>
      <div v-else>
        <table class="vuln-table" v-if="filteredTemplates.length">
          <thead>
            <tr>
              <th>Title</th>
              <th>Severity</th>
              <th>Category</th>
              <th>Global</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="t in filteredTemplates" :key="t.id">
              <td>{{ t.title }}</td>
              <td><span class="sev" :class="(t.severity as unknown as string || '').toLowerCase()">{{ t.severity }}</span></td>
              <td>{{ t.category || '—' }}</td>
              <td>{{ t.isGlobal ? 'Yes' : 'No' }}</td>
              <td><button class="btn btn-tiny" @click="editTemplate(t)">Edit</button></td>
            </tr>
          </tbody>
        </table>
        <p v-else class="empty">No templates match your filters.</p>
      </div>
    </section>

    <div v-if="showModal" class="modal-backdrop">
      <div class="modal">
        <header class="modal-top">
          <h3>{{ form.id ? 'Edit Template' : 'New Template' }}</h3>
          <label class="global-toggle" title="Template available globally">
            <input type="checkbox" v-model="form.isGlobal" />
            <span class="slider" />
            <span class="gt-label">Global</span>
          </label>
        </header>
        <form @submit.prevent="submit" class="template-form">
          <div class="form-grid">
            <label class="full-row">Title<input v-model="form.title" required /></label>
            <label>Category
              <select v-model="form.category">
                <option value="">None</option>
                <option v-for="c in categories" :value="c" :key="c">{{ c }}</option>
              </select>
            </label>
            <label>Likelihood
              <select v-model="form.likelihood">
                <option value="">(auto / unset)</option>
                <option v-for="l in likelihoods" :key="l" :value="l">{{ l }}</option>
              </select>
            </label>
            <label>Impact Level
              <select v-model="form.impactLevel">
                <option value="">(auto / unset)</option>
                <option v-for="i in impactLevels" :key="i" :value="i">{{ i }}</option>
              </select>
            </label>
            <label class="derived-sev-display inline">
              <span>Severity</span>
              <div class="sev-pill" :class="(derivedSeverity||'').toLowerCase()">{{ derivedSeverity || '—' }}</div>
            </label>
          </div>
          <div class="cvss-block">
            <div class="cvss-row">
              <div class="cvss-vector-input">
                <span>CVSS Vector</span>
                <div class="vector-edit">
                  <input v-model="form.cvssVector" placeholder="AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H" />
                  <input class="cvss-score" :value="cvssScore" readonly placeholder="Score" />
                  <button type="button" class="btn tiny builder-btn" @click="showCvss = !showCvss">{{ showCvss ? 'Close' : 'Builder' }}</button>
                </div>
              </div>
            </div>
            <div v-if="showCvss" class="cvss-pop">
              <div class="metric" v-for="m in metrics" :key="m.key">
                <label>{{ m.key }} — {{ metricDetails[m.key].name }}</label>
                <p class="metric-desc">{{ metricDetails[m.key].desc }}</p>
                <div class="options">
                  <button v-for="opt in m.options" :key="opt" type="button" :class="['opt', currentMetricValue(m.key)===opt ? 'active':'']" @click="applyMetric(m.key,opt)">
                    <span class="opt-code">{{ opt }}</span>
                    <span class="opt-name">{{ metricDetails[m.key].values[opt].name }}</span>
                    <span class="opt-desc">{{ metricDetails[m.key].values[opt].desc }}</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="md-field">
            <div class="md-label">Description</div>
            <MarkdownEditor v-model="form.description" :autosave-key="'vulnTemplate:' + (form.id || 'new') + ':desc'" :show-stats="true" />
          </div>
          <div class="md-field">
            <div class="md-label">Impact</div>
            <MarkdownEditor v-model="form.impact" :autosave-key="'vulnTemplate:' + (form.id || 'new') + ':impact'" :show-stats="true" />
          </div>
            <div class="md-field">
              <div class="md-label">Remediation</div>
              <MarkdownEditor v-model="form.remediation" :autosave-key="'vulnTemplate:' + (form.id || 'new') + ':remediation'" :show-stats="true" />
            </div>
          <label>References
            <textarea v-model="referencesInput" rows="2" placeholder="One per line or comma separated"></textarea>
          </label>
          <label>Tags
            <input v-model="tagsInput" placeholder="comma separated (e.g. auth,crypto)" />
          </label>
          <div class="modal-actions">
            <button type="button" class="btn btn-small" @click="closeModal">Cancel</button>
            <button type="submit" class="btn btn-small primary" :disabled="submitting">{{ submitting ? 'Saving...' : 'Save' }}</button>
          </div>
        </form>
      </div>
    </div>
  </DashboardLayout>
</template>
<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import DashboardLayout from '../layouts/DashboardLayout.vue'
import { useVulnerabilityTemplates } from '../composables/useVulnerabilityTemplates'
import MarkdownEditor from '@/components/MarkdownEditor.vue'
import { calculate } from '@/services/cvss'
import { deriveSeverityData } from '@/services/risk'

const { templates, list, create, update, loading } = useVulnerabilityTemplates()

const showModal = ref(false)
const submitting = ref(false)
const search = ref('')
const severityFilter = ref('')
const categoryFilter = ref('')
const severities = ['CRITICAL','HIGH','MEDIUM','LOW','INFO'] // still used for filtering table only
const likelihoods = ['VERY_HIGH','HIGH','MEDIUM','LOW','VERY_LOW']
const impactLevels = ['CRITICAL','HIGH','MEDIUM','LOW']
const categories = ref<string[]>([])

const form = ref<{ id: string; title: string; severity: string; category: string; isGlobal: boolean; description: string; remediation: string; impact: string; likelihood: string; impactLevel: string; references: string[]; tags: string[]; cvssVector: string }>({
  id: '',
  title: '',
  severity: 'MEDIUM',
  category: '',
  isGlobal: true,
  description: '',
  remediation: '',
  impact: '',
  likelihood: '',
  impactLevel: '',
  references: [],
  tags: [],
  cvssVector: ''
})
const referencesInput = ref('')
const tagsInput = ref('')

// CVSS builder state & helpers (base metrics only)
const showCvss = ref(false)
interface MetricDef { key: string; options: string[] }
interface MetricMeta { name: string; desc: string; values: Record<string,{ name:string; desc:string }> }
const metricDetails: Record<string, MetricMeta> = {
  AV: { name:'Attack Vector', desc:'How the vulnerability is exploited.', values:{ N:{name:'Network',desc:'Remote over network'}, A:{name:'Adjacent',desc:'Same network segment'}, L:{name:'Local',desc:'Local access required'}, P:{name:'Physical',desc:'Physical interaction'} } },
  AC: { name:'Attack Complexity', desc:'Conditions beyond attacker control.', values:{ L:{name:'Low',desc:'No special conditions'}, H:{name:'High',desc:'Specific conditions required'} } },
  PR: { name:'Privileges Required', desc:'Privileges required before exploit.', values:{ N:{name:'None',desc:'No auth needed'}, L:{name:'Low',desc:'Basic user'}, H:{name:'High',desc:'Admin / powerful'} } },
  UI: { name:'User Interaction', desc:'End-user participation needed?', values:{ N:{name:'None',desc:'No user action'}, R:{name:'Required',desc:'Requires user action'} } },
  S: { name:'Scope', desc:'Resources beyond initial scope?', values:{ U:{name:'Unchanged',desc:'Single component'}, C:{name:'Changed',desc:'Other components impacted'} } },
  C: { name:'Confidentiality', desc:'Impact to confidentiality.', values:{ H:{name:'High',desc:'Total loss'}, L:{name:'Low',desc:'Partial loss'}, N:{name:'None',desc:'No impact'} } },
  I: { name:'Integrity', desc:'Impact to integrity.', values:{ H:{name:'High',desc:'Complete loss'}, L:{name:'Low',desc:'Modification possible'}, N:{name:'None',desc:'No impact'} } },
  A: { name:'Availability', desc:'Impact to availability.', values:{ H:{name:'High',desc:'Service down'}, L:{name:'Low',desc:'Performance hit'}, N:{name:'None',desc:'No impact'} } },
}
const metrics: MetricDef[] = Object.keys(metricDetails).map(k=>({ key:k, options:Object.keys(metricDetails[k].values) }))
function currentMetricValue(metric: string) {
  const segs = (form.value.cvssVector || '').split('/')
  for (const s of segs) { const [k,v] = s.split(':'); if (k===metric) return v }
  return ''
}
function applyMetric(metric: string, val: string){
  const segs: string[] = (form.value.cvssVector || '')
    .split('/')
    .filter((s: string) => !!s)
    .filter((s: string) => !s.startsWith(metric+':'))
  segs.push(`${metric}:${val}`)
  const order = ['AV','AC','PR','UI','S','C','I','A']
  segs.sort((a: string, b: string)=> order.indexOf(a.split(':')[0]) - order.indexOf(b.split(':')[0]))
  form.value.cvssVector = segs.join('/')
}

onMounted(async () => {
  await list()
  categories.value = Array.from(new Set(templates.value.map(t => t.category).filter(Boolean))) as string[]
})

const filteredTemplates = computed(() => {
  return templates.value.filter(t => {
    const matchesSearch = !search.value || t.title.toLowerCase().includes(search.value.toLowerCase()) || (t.description || '').toLowerCase().includes(search.value.toLowerCase())
    const matchesSeverity = !severityFilter.value || t.severity === severityFilter.value
    const matchesCategory = !categoryFilter.value || t.category === categoryFilter.value
    return matchesSearch && matchesSeverity && matchesCategory
  })
})

function openModal() {
  resetForm();
  showModal.value = true
}
function editTemplate(t: any) {
  form.value = { id: t.id, title: t.title, severity: t.severity, category: t.category||'', isGlobal: t.isGlobal !== false, description: t.description||'', remediation: t.remediation||'', impact: t.impact||'', likelihood: t.likelihood||'', impactLevel: t.impactLevel||'', references: t.references||[], tags: t.tags||[], cvssVector: t.cvssVector||'' }
  referencesInput.value = (form.value.references || []).join('\n')
  tagsInput.value = (form.value.tags || []).join(', ')
  showModal.value = true
}
function closeModal() { showModal.value = false }
function resetForm() {
  form.value = { id:'', title:'', severity:'MEDIUM', category:'', isGlobal:true, description:'', remediation:'', impact:'', likelihood:'', impactLevel:'', references:[], tags:[], cvssVector:'' }
  referencesInput.value = ''
  tagsInput.value = ''
}
const cvssScore = computed(() => {
  if (!form.value.cvssVector) return ''
  try { const res = calculate(form.value.cvssVector); return res ? res.score.toFixed(1) : '' } catch { return '' }
})

// Centralized severity derivation
const derivedResult = ref<{ likelihood?: string; impactLevel?: string; severity?: string }>({})
async function recomputeDerived() {
  const res = await deriveSeverityData({
    likelihood: (form.value.likelihood || undefined) as any,
    impactLevel: (form.value.impactLevel || undefined) as any,
    cvssVector: form.value.cvssVector || undefined
  })
  derivedResult.value = res
}
watch(()=>[form.value.likelihood, form.value.impactLevel, form.value.cvssVector], ()=>{ recomputeDerived() }, { immediate:true })
const derivedSeverity = computed(()=> derivedResult.value.severity || '')
function splitMulti(val: string) { return val.split(/[\n,]/).map(v=>v.trim()).filter(Boolean) }
async function submit() {
  submitting.value = true
  try {
    form.value.references = splitMulti(referencesInput.value)
    form.value.tags = splitMulti(tagsInput.value)
    const payload: any = { ...form.value }
    if (payload.category === '') payload.category = undefined
    // Derive severity if possible
    if (derivedSeverity.value) payload.severity = derivedSeverity.value
    if (!payload.severity) payload.severity = 'MEDIUM'
    if (!payload.impactLevel) delete payload.impactLevel
    if (!payload.likelihood) delete payload.likelihood
  if (!payload.cvssVector) delete payload.cvssVector
    if (!payload.references?.length) delete payload.references
    if (!payload.tags?.length) delete payload.tags
    if (form.value.id) {
      await update(form.value.id, payload)
    } else {
      await create(payload)
    }
    await list()
    closeModal()
  } finally {
    submitting.value = false
  }
}
</script>
<style scoped>
/* Modal structural tweaks relying on global modal.css for theme */
.modal { width:880px; max-width:96%; }
.modal-top { display:flex; align-items:center; justify-content:space-between; margin:0 0 .75rem; }
.modal-top h3 { margin:0; font-size:1rem; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.75rem; margin-bottom:.75rem; }
.form-grid label { display:flex; flex-direction:column; font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; gap:.25rem; }
.form-grid .full-row { grid-column:1 / -1; }
.derived-sev-display { display:flex; flex-direction:column; gap:.25rem; font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; }
.derived-sev-display.inline { justify-content:flex-end; align-self:stretch; }
.derived-sev-display.inline .sev-pill { display:flex; align-items:center; justify-content:center; height:100%; }
.sev-pill { padding:0 .65rem; border-radius:8px; font-size:.6rem; font-weight:600; text-align:center; background:#334155; min-height:calc(2.1em); line-height:1; }
.sev-pill.critical { background:#dc2626; color:#fff; }
.sev-pill.high { background:#f97316; color:#fff; }
.sev-pill.medium { background:#fbbf24; color:#111; }
.sev-pill.low { background:#0ea5e9; color:#fff; }
.sev-pill.info { background:#6366f1; color:#fff; }
/* legacy chk-full removed */
textarea { resize:vertical; }
.modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem; }
.md-field { margin-top:.9rem; display:flex; flex-direction:column; gap:.5rem; }
.md-label { font-size:.65rem; font-weight:600; letter-spacing:.05em; text-transform:uppercase; opacity:.85; }
.md-field :deep(.md-editor) { min-height:220px; }
.modal { max-height:90vh; overflow:auto; }
/* CVSS builder styles (lean version) */
.cvss-block { margin-top:.5rem; border:1px solid var(--color-border,#39424e); border-radius:12px; padding:.85rem .9rem; display:flex; flex-direction:column; gap:.75rem; }
.cvss-row { display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end; }
.cvss-vector-input { flex:1; display:flex; flex-direction:column; gap:.35rem; font-size:.6rem; text-transform:uppercase; letter-spacing:.05em; }
.vector-edit { display:flex; gap:.5rem; align-items:stretch; }
.vector-edit input { flex:1; }
.vector-edit .builder-btn { padding:.55rem .85rem; font-size:.6rem; height:100%; display:flex; align-items:center; }
.cvss-score { width:70px; text-align:center; font-size:.65rem; background:var(--color-input,#1f2735); border:1px solid var(--color-border,#2c3848); border-radius:8px; }
input.cvss-score[readonly] { opacity:.85; }
.cvss-pop { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:.75rem; }
.metric { display:flex; flex-direction:column; gap:.35rem; border:1px solid var(--color-border,#39424e); border-radius:10px; padding:.6rem .6rem .7rem; }
.metric-desc { margin:0; font-size:.55rem; opacity:.65; line-height:1.25; }
.metric label { font-size:.6rem; font-weight:600; letter-spacing:.05em; opacity:.75; }
.options { display:flex; flex-direction:column; gap:.3rem; }
.opt { background:#1f2735; border:1px solid #2c3848; border-radius:8px; padding:.4rem .5rem; font-size:.55rem; cursor:pointer; display:flex; flex-direction:column; gap:.15rem; text-align:left; }
.opt.active { background:#6366f1; color:#fff; border-color:#6366f1; }
.opt-code { font-weight:700; letter-spacing:.05em; font-size:.55rem; opacity:.85; }
.opt-name { font-weight:600; }
.opt-desc { font-size:.5rem; line-height:1.2; opacity:.85; }
/* Global slider */
.global-toggle { position:relative; display:inline-flex; align-items:center; gap:.5rem; font-size:.6rem; font-weight:600; letter-spacing:.05em; text-transform:uppercase; }
.global-toggle input { position:absolute; opacity:0; pointer-events:none; }
.global-toggle .slider { width:38px; height:18px; background:#334155; border-radius:20px; position:relative; transition:.25s; }
.global-toggle .slider:before { content:''; position:absolute; top:2px; left:2px; width:14px; height:14px; background:#fff; border-radius:50%; transition:.25s; }
.global-toggle input:checked + .slider { background:#6366f1; }
.global-toggle input:checked + .slider:before { transform:translateX(20px); }
.global-toggle .gt-label { font-size:.55rem; opacity:.8; }
</style>
