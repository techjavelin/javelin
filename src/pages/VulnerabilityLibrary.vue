<template>
  <DashboardLayout>
    <h1 class="dashboard-title">Vulnerability Library</h1>
    <section class="library-panel">
      <div class="filters">
        <input v-model="search" placeholder="Search title or description" />
        <select v-model="severityFilter">
          <option value="">All Severities</option>
          <option v-for="s in severities" :key="s" :value="s">{{ s }}</option>
        </select>
        <select v-model="categoryFilter">
          <option value="">All Categories</option>
          <option v-for="c in categories" :key="c" :value="c">{{ c }}</option>
        </select>
        <button class="btn btn-small" @click="openModal">New Template</button>
      </div>
      <div v-if="loading" class="loading">Loading templates...</div>
      <div v-else>
        <table class="vuln-table" v-if="filteredTemplates.length">
          <thead>
            <tr>
              <th>Title</th>
              <th>Severity</th>
              <th>Category</th>
              <th>Global</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="t in filteredTemplates" :key="t.id">
              <td>{{ t.title }}</td>
              <td><span class="sev" :class="(t.severity as unknown as string || '').toLowerCase()">{{ t.severity }}</span></td>
              <td>{{ t.category || 'â€”' }}</td>
              <td>{{ t.isGlobal ? 'Yes' : 'No' }}</td>
              <td><button class="btn btn-tiny" @click="editTemplate(t)">Edit</button></td>
            </tr>
          </tbody>
        </table>
        <p v-else class="empty">No templates match your filters.</p>
      </div>
    </section>

    <div v-if="showModal" class="modal-backdrop">
      <div class="modal">
        <h3>{{ form.id ? 'Edit Template' : 'New Template' }}</h3>
        <form @submit.prevent="submit">
          <div class="form-grid">
            <label>Title<input v-model="form.title" required /></label>
            <label>Severity
              <select v-model="form.severity" required>
                <option disabled value="">Select</option>
                <option v-for="s in severities" :value="s" :key="s">{{ s }}</option>
              </select>
            </label>
            <label>Category
              <select v-model="form.category">
                <option value="">None</option>
                <option v-for="c in categories" :value="c" :key="c">{{ c }}</option>
              </select>
            </label>
            <label class="chk-full"><input type="checkbox" v-model="form.isGlobal" /> Global</label>
          </div>
          <label>Description<textarea v-model="form.description" rows="3"></textarea></label>
          <label>Remediation<textarea v-model="form.remediation" rows="3"></textarea></label>
          <div class="modal-actions">
            <button type="button" class="btn btn-small" @click="closeModal">Cancel</button>
            <button type="submit" class="btn btn-small primary" :disabled="submitting">{{ submitting ? 'Saving...' : 'Save' }}</button>
          </div>
        </form>
      </div>
    </div>
  </DashboardLayout>
</template>
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import DashboardLayout from '../layouts/DashboardLayout.vue'
import { useVulnerabilityTemplates } from '../composables/useVulnerabilityTemplates'

const { templates, list, create, update, loading } = useVulnerabilityTemplates()

const showModal = ref(false)
const submitting = ref(false)
const search = ref('')
const severityFilter = ref('')
const categoryFilter = ref('')
const severities = ['Critical','High','Medium','Low','Info']
const categories = ref<string[]>([])

const form = ref({
  id: '',
  title: '',
  severity: '',
  category: '',
  isGlobal: false,
  description: '',
  remediation: ''
})

onMounted(async () => {
  await list()
  categories.value = Array.from(new Set(templates.value.map(t => t.category).filter(Boolean))) as string[]
})

const filteredTemplates = computed(() => {
  return templates.value.filter(t => {
    const matchesSearch = !search.value || t.title.toLowerCase().includes(search.value.toLowerCase()) || (t.description || '').toLowerCase().includes(search.value.toLowerCase())
    const matchesSeverity = !severityFilter.value || t.severity === severityFilter.value
    const matchesCategory = !categoryFilter.value || t.category === categoryFilter.value
    return matchesSearch && matchesSeverity && matchesCategory
  })
})

function openModal() {
  resetForm();
  showModal.value = true
}
function editTemplate(t: any) {
  form.value = { ...t }
  showModal.value = true
}
function closeModal() { showModal.value = false }
function resetForm() {
  form.value = { id:'', title:'', severity:'', category:'', isGlobal:false, description:'', remediation:'' }
}
async function submit() {
  submitting.value = true
  try {
    const payload: any = { ...form.value }
    // Coerce to backend enum expectations
    if (payload.category === '') payload.category = undefined
    if (payload.severity === '') payload.severity = undefined
    if (form.value.id) {
      await update(form.value.id, payload)
    } else {
      await create(payload)
    }
    await list()
    closeModal()
  } finally {
    submitting.value = false
  }
}
</script>
<style scoped>
/* Modal structural tweaks relying on global modal.css for theme */
.modal { width:560px; max-width:95%; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.75rem; margin-bottom:.75rem; }
.form-grid label { display:flex; flex-direction:column; font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; gap:.25rem; }
.chk-full { grid-column:1 / -1; flex-direction:row !important; align-items:center; gap:.5rem; }
textarea { resize:vertical; }
.modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem; }
</style>
