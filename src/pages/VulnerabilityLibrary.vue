<template>
  <DashboardLayout>
    <h1 class="dashboard-title">Vulnerability Library</h1>
    <section class="library-panel">
      <div class="filters">
        <input v-model="search" placeholder="Search title or description" />
        <select v-model="severityFilter">
          <option value="">All Severities</option>
          <option v-for="s in severities" :key="s" :value="s">{{ s }}</option>
        </select>
        <select v-model="categoryFilter">
          <option value="">All Categories</option>
          <option v-for="c in categories" :key="c" :value="c">{{ c }}</option>
        </select>
        <button class="btn btn-small" @click="openModal">New Template</button>
      </div>
      <div v-if="loading" class="loading">Loading templates...</div>
      <div v-else>
        <table class="vuln-table" v-if="filteredTemplates.length">
          <thead>
            <tr>
              <th>Title</th>
              <th>Severity</th>
              <th>Category</th>
              <th>Global</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="t in filteredTemplates" :key="t.id">
              <td>{{ t.title }}</td>
              <td><span class="sev" :class="(t.severity as unknown as string || '').toLowerCase()">{{ t.severity }}</span></td>
              <td>{{ t.category || 'â€”' }}</td>
              <td>{{ t.isGlobal ? 'Yes' : 'No' }}</td>
              <td><button class="btn btn-tiny" @click="editTemplate(t)">Edit</button></td>
            </tr>
          </tbody>
        </table>
        <p v-else class="empty">No templates match your filters.</p>
      </div>
    </section>

    <div v-if="showModal" class="modal-backdrop">
      <div class="modal">
        <h3>{{ form.id ? 'Edit Template' : 'New Template' }}</h3>
        <form @submit.prevent="submit">
          <div class="form-grid">
            <label>Title<input v-model="form.title" required /></label>
            <label>Severity
              <select v-model="form.severity" required>
                <option disabled value="">Select</option>
                <option v-for="s in severities" :value="s" :key="s">{{ s }}</option>
              </select>
            </label>
            <label>Category
              <select v-model="form.category">
                <option value="">None</option>
                <option v-for="c in categories" :value="c" :key="c">{{ c }}</option>
              </select>
            </label>
            <label class="chk-full"><input type="checkbox" v-model="form.isGlobal" /> Global</label>
          </div>
          <label>Description<textarea v-model="form.description" rows="3"></textarea></label>
          <label>Remediation<textarea v-model="form.remediation" rows="3"></textarea></label>
          <div class="modal-actions">
            <button type="button" class="btn btn-small" @click="closeModal">Cancel</button>
            <button type="submit" class="btn btn-small primary" :disabled="submitting">{{ submitting ? 'Saving...' : 'Save' }}</button>
          </div>
        </form>
      </div>
    </div>
  </DashboardLayout>
</template>
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import DashboardLayout from '../layouts/DashboardLayout.vue'
import { useVulnerabilityTemplates } from '../composables/useVulnerabilityTemplates'

const { templates, list, create, update, loading } = useVulnerabilityTemplates()

const search = ref('')
const severityFilter = ref('')
const categoryFilter = ref('')
const showModal = ref(false)
const submitting = ref(false)
const form = ref<any>({ title: '', severity: '', category: '', isGlobal: false, description: '', remediation: '' })

const severities = ['CRITICAL','HIGH','MEDIUM','LOW','INFO']
const categories = ['CONFIG','AUTH','CRYPTO','INPUT','ACCESS','OTHER']

onMounted(async () => { await list() })

const filteredTemplates = computed(() => {
  return templates.value.filter(t => {
    if (search.value) {
      const q = search.value.toLowerCase()
      if (!t.title?.toLowerCase().includes(q) && !t.description?.toLowerCase().includes(q)) return false
    }
    if (severityFilter.value && t.severity !== severityFilter.value) return false
    if (categoryFilter.value && t.category !== categoryFilter.value) return false
    return true
  })
})

function openModal() { form.value = { title: '', severity: '', category: '', isGlobal: false, description: '', remediation: '' }; showModal.value = true }
function closeModal() { showModal.value = false }
function editTemplate(t:any) { form.value = { ...t }; showModal.value = true }

async function submit() {
  submitting.value = true
  if (form.value.id) {
    await update(form.value.id, { title: form.value.title, severity: form.value.severity, category: form.value.category, isGlobal: form.value.isGlobal, description: form.value.description, remediation: form.value.remediation })
  } else {
    await create({ title: form.value.title, severity: form.value.severity, category: form.value.category, isGlobal: form.value.isGlobal, description: form.value.description, remediation: form.value.remediation })
  }
  submitting.value = false
  closeModal()
}
</script>
<style scoped>
.dashboard-title { font-size:2rem; font-weight:700; color:#fff; margin:0 0 1rem; }
.library-panel { background:#181e2a; padding:1.5rem; border-radius:14px; border:1px solid #243048; }
.filters { display:flex; flex-wrap:wrap; gap:.75rem; margin-bottom:1rem; }
.filters input, .filters select { background:#0f1623; color:#fff; border:1px solid #243044; padding:.55rem .7rem; border-radius:6px; font-size:.8rem; }
.btn { background:#2563eb; border:none; color:#fff; padding:.6rem 1rem; border-radius:6px; cursor:pointer; font-size:.75rem; font-weight:600; }
.btn-small { padding:.45rem .75rem; font-size:.7rem; }
.btn-tiny { padding:.3rem .55rem; font-size:.6rem; }
.btn.primary { background:#2563eb; }
.btn:disabled { opacity:.5; cursor:default; }
.vuln-table { width:100%; border-collapse:collapse; font-size:.75rem; }
.vuln-table th, .vuln-table td { padding:.55rem .6rem; text-align:left; border-bottom:1px solid #243044; }
.vuln-table th { font-size:.6rem; text-transform:uppercase; letter-spacing:.06em; color:#94a3b8; }
.sev { display:inline-block; padding:.25rem .5rem; border-radius:4px; font-size:.6rem; font-weight:600; }
.sev.critical { background:#991b1b; color:#fff; }
.sev.high { background:#dc2626; color:#fff; }
.sev.medium { background:#ea580c; color:#fff; }
.sev.low { background:#d97706; color:#fff; }
.sev.info { background:#1e3a8a; color:#fff; }
.empty { color:#64748b; font-size:.75rem; }
.loading { color:#94a3b8; font-size:.75rem; }
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; align-items:center; justify-content:center; z-index:60; }
.modal { background:#1e293b; padding:1.25rem 1.25rem 1.4rem; border-radius:14px; width:560px; max-width:95%; }
.modal h3 { margin-top:0; margin-bottom:.75rem; font-size:1rem; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.75rem; margin-bottom:.75rem; }
.form-grid label { display:flex; flex-direction:column; font-size:.65rem; text-transform:uppercase; letter-spacing:.05em; color:#94a3b8; gap:.25rem; }
.form-grid input, .form-grid select, textarea { background:#0f1623; color:#fff; border:1px solid #243044; padding:.45rem .55rem; border-radius:6px; font-size:.7rem; }
.chk-full { grid-column:1 / -1; flex-direction:row !important; align-items:center; gap:.5rem; }
textarea { resize:vertical; }
.modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem; }
</style>
